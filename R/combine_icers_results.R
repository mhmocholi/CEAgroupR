#' Combine bootstrap samples from one or several cost-effectiveness analyses
#'
#' Combines bootstrap replicates produced by \code{\link{compute_icers}} and
#' contained in one or more objects of class \code{cea_results} or
#' \code{cea_results_list} into a single tidy tibble.
#' This function preserves subgroup structure by keeping both the subgroup
#' variable name (\code{subgroup_var}) and its level (\code{subgroup_level})
#' for each set of bootstrap replicates. A unique hierarchical identifier
#' (\code{group_uid}) is added to prevent mixing of subgroups during plotting.
#'
#' @param ... One or several \code{cea_results} or \code{cea_results_list}
#' objects generated by \code{\link{compute_icers}}.
#'
#' @return A tibble containing all bootstrap replicates, including dataset name,
#' subgroup variable and level, replicate ID, hierarchical identifier
#' (\code{group_uid}), and all bootstrap statistics (\code{Delta_Cost},
#' \code{Delta_Effect}, \code{ICER}, and NMB values).
#' @export
combine_icers_results <- function(...) {

  objects <- list(...)
  n_objs <- length(objects)
  if (n_objs == 0) stop("At least one object must be provided.")

  # ---- Unpack cea_results_list if provided ----
  if (n_objs == 1 && inherits(objects[[1]], "cea_results_list")) {
    objects <- objects[[1]]
    n_objs <- length(objects)
  }

  # ---- Filter valid analysis elements ----
  objects <- Filter(function(x)
    is.list(x) && ("Overall" %in% names(x) || "Subgroups" %in% names(x)),
    objects)
  if (length(objects) == 0)
    stop("No valid 'cea_results' objects found for combination.")

  # ---- Helper: extract bootstrap samples from one cea_results ----
  extract_bootstrap <- function(res_obj, dataset_name) {

    extract_one <- function(x, subgroup_var = NA, subgroup_level = NA) {
      if (is.null(x$bootstrap_samples)) return(NULL)
      df <- x$bootstrap_samples
      if (is.null(df) || nrow(df) == 0) return(NULL)
      df$replicate <- seq_len(nrow(df))
      df$dataset <- dataset_name
      # Force both subgroup_var and subgroup_level to character
      df$subgroup_var <- ifelse(is.na(subgroup_var), "Overall", as.character(subgroup_var))
      df$subgroup_level <- ifelse(is.na(subgroup_level), "Overall", as.character(subgroup_level))
      df
    }

    # Overall results
    overall_df <- extract_one(res_obj$Overall)

    # Subgroups (preserve variable and level structure)
    sub_df <- NULL
    if (!is.null(res_obj$Subgroups) && length(res_obj$Subgroups) > 0) {
      sub_df <- dplyr::bind_rows(lapply(names(res_obj$Subgroups), function(var) {
        dplyr::bind_rows(lapply(names(res_obj$Subgroups[[var]]), function(lvl) {
          extract_one(res_obj$Subgroups[[var]][[lvl]],
                      subgroup_var = var,
                      subgroup_level = lvl)
        }))
      }))
    }

    dplyr::bind_rows(overall_df, sub_df)
  }

  # ---- Combine all datasets ----
  combined_list <- lapply(names(objects), function(ds_name) {
    df <- extract_bootstrap(objects[[ds_name]], ds_name)
    if (is.null(df) || nrow(df) == 0) return(NULL)
    df
  })

  combined_df <- dplyr::bind_rows(combined_list)

  # ---- Add unique hierarchical identifier ----
  combined_df$group_uid <- with(
    combined_df,
    paste0(dataset, "_", subgroup_var, "_", subgroup_level)
  )

  # ---- Reorder columns ----
  base_cols <- c(
    "dataset", "subgroup_var", "subgroup_level", "group_uid", "replicate",
    "Delta_Cost", "Delta_Effect", "ICER",
    "Mean_Cost_g1", "Mean_Cost_g2",
    "Mean_Effect_g1", "Mean_Effect_g2"
  )
  nmb_cols <- grep("^NMB_", names(combined_df), value = TRUE)
  col_order <- c(base_cols, nmb_cols)
  existing_cols <- intersect(col_order, names(combined_df))
  combined_df <- combined_df[, existing_cols]

  tibble::as_tibble(combined_df)
}
