---
title: "Demostraci√≥n del paquete CEAgroupR"
author: "Proyecto de Tesis - An√°lisis de Coste-Utilidad por Subgrupos"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all(".")   # Carga el paquete desde el proyecto actual
library(dplyr)
library(ggplot2)
```

# Introducci√≥n

Este documento muestra el flujo completo del paquete **CEAgroupR**, dise√±ado para realizar
**an√°lisis de coste-efectividad (CEA)** y **coste-utilidad (CUA)** con soporte para
an√°lisis por subgrupos y escenarios alternativos.

El paquete permite:

- Calcular de forma reproducible razones de coste-efectividad incremental (ICER)
  y beneficio monetario neto (NMB) mediante *bootstrap* no param√©trico.  
- Comparar resultados entre distintos **datasets** (escenarios o an√°lisis de sensibilidad).  
- Realizar an√°lisis por **subgrupos** definidos por variables categ√≥ricas.  
- Generar visualizaciones flexibles:
  - Plano coste-efectividad (ICER plane)
  - Curvas de aceptabilidad (CEAC)
  - Curvas de valor esperado de informaci√≥n perfecta (EVPI)

# 1. Estructura de los datos

El paquete incluye dos datasets de ejemplo:

```{r}
data(cua_base)
data(cua_base_discounted)

head(cua_base)
```

Cada dataset contiene:

| Variable | Descripci√≥n |
|-----------|-------------|
| `id` | Identificador individual |
| `group` | Grupo de comparaci√≥n ("g0" = usual care, "g1" = intervenci√≥n) |
| `cost_total` | Coste total individual |
| `effect` | Efectividad o utilidad (p. ej., QALYs) |
| `diabetes` | Indicador de diabetes ("yes"/"no") |
| `HTA` | Hipertensi√≥n ("yes"/"no") |
| `n_comorbidities` | N√∫mero de comorbilidades (0‚Äì3) |

El dataset `cua_base_discounted` es una versi√≥n con un 10% de descuento en costes
para ilustrar un **an√°lisis de sensibilidad determin√≠stico**.

# 2. Generaci√≥n de resultados

```{r}
results <- icers_base(
  data = list(
    base_case = cua_base,
    discounted = cua_base_discounted
  ),
  group = "group",
  cost = "cost_total",
  effect = "effect",
  lambda = 25000,
  R = 500,
  subgroup_vars = c("diabetes", "HTA")
)
```

El objeto `results` incluye:

- Resultados *bootstrap* globales (`$Overall`)  
- Resultados por subgrupos (`$Subgroups`)  
- Tabla combinada de r√©plicas (`$combined_replicates`)

```{r}
str(results, max.level = 2)
```

## 2.1. Resumen num√©rico

```{r}
results$base_case
```

# 3. Visualizaciones

Las funciones gr√°ficas del paquete comparten la misma estructura flexible
(`mode`, `facet_by`, `palette`, etc.).

## 3.1. Plano coste-efectividad (ICER plane)

**Comparaci√≥n global**

```{r}
plot.icers(results, mode = "overall")
```

**Comparaci√≥n por datasets**

```{r}
plot.icers(results, mode = "overall", facet = TRUE)
```

**Subgrupos por variable**

```{r}
plot.icers(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

**Subgrupos por nivel**

```{r}
plot.icers(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "levels"
)
```

**Comparaci√≥n datasets √ó subgrupos**

```{r}
plot.icers(
  results,
  mode = "datasets_subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

## 3.2. Curvas de aceptabilidad (CEAC)

**Global**

```{r}
plot.ceac(results, mode = "overall", lambda_range = c(0, 80000))
```

**Por variable (Diabetes, HTA)**

```{r}
plot.ceac(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

**Por nivel (yes/no)**

```{r}
plot.ceac(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "levels"
)
```

**Comparaci√≥n datasets √ó subgrupos**

```{r}
plot.ceac(
  results,
  mode = "datasets_subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

## 3.3. Curvas de valor esperado de informaci√≥n perfecta (EVPI)

**Global**

```{r}
plot.evpi(results, mode = "overall")
```

**Por variable**

```{r}
plot.evpi(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

**Por nivel**

```{r}
plot.evpi(
  results,
  mode = "subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "levels"
)
```

**Comparaci√≥n datasets √ó subgrupos**

```{r}
plot.evpi(
  results,
  mode = "datasets_subgroups",
  subgroups = c("diabetes", "HTA"),
  facet_by = "vars"
)
```

# 4. Conclusi√≥n

El flujo mostrado en este documento demuestra el funcionamiento modular del paquete **CEAgroupR**:  
desde la generaci√≥n de r√©plicas *bootstrap* hasta la visualizaci√≥n comparativa.

La arquitectura de modos y facetas ofrece una gran flexibilidad para realizar
an√°lisis coste-efectividad globales, por subgrupos y entre escenarios,
manteniendo una presentaci√≥n coherente y reproducible.

# 5. Ap√©ndice t√©cnico: Documentaci√≥n de funciones

La documentaci√≥n completa de cada funci√≥n puede abrirse desde los enlaces siguientes.  
Los archivos `.html` de ayuda fueron generados con la funci√≥n `tools::Rd2HTML()`
a partir de los archivos `.Rd` en la carpeta `man/`.

> üí° Todos los enlaces funcionan en local; aseg√∫rate de que los archivos `.html`
> est√©n ubicados en el mismo nivel de carpeta que este documento (o ajusta las rutas `../` si el Rmd est√° dentro de `/R`).

- [icers_base](../icers_base.html)
- [combine_icers_results](../combine_icers_results.html)
- [plot.icers](../plot.icers.html)
- [plot.ceac](../plot.ceac.html)
- [plot.evpi](../plot.evpi.html)
