#' Print method for cea_results objects
#'
#' Displays a summary table of bootstrap results when printing a
#' \code{cea_results} object. Extracts mean estimates and 95% confidence intervals
#' from stored bootstrap results for both the overall and subgroup analyses.
#' Automatically recognises multiple Net Monetary Benefit (NMB) parameters if
#' several willingness-to-pay thresholds (\code{lambda}) were specified.
#'
#' This method is typically applied to the elements generated by
#' \code{\link{compute_icers}}, summarising the results for each dataset and
#' subgroup within a cost-effectiveness analysis.
#'
#' @param x An object of class \code{cea_results}, typically one element of the
#'   list returned by \code{\link{compute_icers}}.
#' @param digits Integer. Number of decimal places to display (default = 3).
#' @param ... Additional arguments (currently unused).
#'
#' @return Invisibly returns the input object \code{x} after printing its summary.
#' @importFrom tibble tibble
#' @importFrom dplyr bind_rows
#' @export
print.cea_results <- function(x, digits = 3, ...) {

  # ---- Helper: extract mean and CI from a cea_base object ----
  summarize_from_object <- function(base_obj, level = "Overall", subgroup = "") {
    if (is.null(base_obj$bootstrap_samples)) return(NULL)

    means <- colMeans(base_obj$bootstrap_samples, na.rm = TRUE)
    cis <- base_obj$boot_ci
    lower <- sapply(cis, function(ci) ci[1])
    upper <- sapply(cis, function(ci) ci[2])

    tibble::tibble(
      Level = level,
      Subgroup = subgroup,
      Parameter = names(means),
      Mean = round(means, digits),
      Lower_95 = round(lower, digits),
      Upper_95 = round(upper, digits)
    )
  }

  # ---- Collect results for overall and subgroups ----
  res_all <- list()

  # Overall
  if (!is.null(x$Overall)) {
    res_all[[length(res_all) + 1]] <- summarize_from_object(x$Overall, "Overall", "")
  }

  # Subgroups
  if (!is.null(x$Subgroups) && length(x$Subgroups) > 0) {
    for (var in names(x$Subgroups)) {
      for (lvl in names(x$Subgroups[[var]])) {
        sub_obj <- x$Subgroups[[var]][[lvl]]
        res_all[[length(res_all) + 1]] <- summarize_from_object(sub_obj, var, lvl)
      }
    }
  }

  # ---- Combine all results ----
  res_summary <- dplyr::bind_rows(res_all)
  if (nrow(res_summary) == 0) {
    cat("No bootstrap summary data available.\n")
    return(invisible(x))
  }

  # ---- Detect NMB columns dynamically ----
  nmb_params <- grep("^NMB_", res_summary$Parameter, value = TRUE)
  lambda_values <- unique(gsub("NMB_", "", nmb_params))

  # ---- Header ----
  cat("------------------------------------------------------------\n")
  cat(" Cost-Effectiveness Analysis Results\n")
  cat("------------------------------------------------------------\n")
  if (length(lambda_values) > 0) {
    cat("Willingness-to-pay thresholds (λ): ",
        paste(lambda_values, collapse = ", "), "\n", sep = "")
  } else {
    cat("Willingness-to-pay threshold (λ): single value\n")
  }
  cat("Displayed values are bootstrap means and 95% confidence intervals.\n\n")

  # ---- Format columns for printing ----
  num_cols <- sapply(res_summary, is.numeric)
  res_summary[num_cols] <- lapply(res_summary[num_cols], function(col)
    format(round(col, digits), nsmall = digits, justify = "right"))
  char_cols <- !num_cols
  res_summary[char_cols] <- lapply(res_summary[char_cols], function(col)
    format(col, justify = "left"))

  # ---- Print formatted summary ----
  print.data.frame(res_summary, row.names = FALSE, right = TRUE)
  cat("\n")

  invisible(x)
}
