---
title: "Multigroup Cost-Effectiveness Analysis with CEAgroupR"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
vignette: >
  %\VignetteIndexEntry{Multigroup Cost-Effectiveness Analysis with CEAgroupR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(CEAgroupR)
library(ggplot2)
library(dplyr)
```

# Introduction

The **CEAgroupR** package provides a unified framework for performing
multidimensional cost-effectiveness analyses in settings where economic
evaluations must compare multiple strategies, across multiple datasets,
and optionally across relevant subgroups.

This vignette illustrates how to apply the package to *multigroup* analysis,
where multiple datasets (e.g., base case and discounted scenario) are processed
simultaneously, and visualized through a graphical engine providing a consistent
set of aesthetics across all plots.

The examples in this vignette use two bundled datasets:

- `cua_multi`  
- `cua_multi_discounted`  

Both contain individual-level cost and effectiveness values for several
intervention strategies.

# Data structure

Each dataset includes:

- `id`: individual identifier  
- `group`: treatment strategy  
- `cost_total`: total cost  
- `effect`: effectiveness/QALYs  
- subgroup variables such as `diabetes`, `HTA`, `n_comorbidities`  

Let us inspect them:

```{r glimpse-data}
glimpse(cua_multi)
glimpse(cua_multi_discounted)
```

# Preparing multigroup input

To run a multigroup analysis, the input must be a **named list** of datasets:

```{r prepare-list}
data_list <- list(
  Base       = cua_multi,
  Discounted = cua_multi_discounted
)
```

# Running a full cost-effectiveness analysis

The main function is `compute_icers()`, which performs bootstrap-based
estimation of:

- incremental cost  
- incremental effect  
- ICER  
- Net Monetary Benefit (NMB)  
- per dataset, per comparison, per subgroup  

We request subgroup analyses by `diabetes` and `HTA`.

```{r compute-icers, message=FALSE}
set.seed(123)

res <- compute_icers(
  data          = data_list,
  group         = "group",
  cost          = "cost_total",
  effect        = "effect",
  R             = 500,               # reduced for vignette speed
  lambda        = c(20000, 30000),   # two WTP thresholds
  ci_type       = "bca",
  subgroup_vars = c("diabetes", "HTA"),
  ref_group     = "usual_care",
  alt_groups    = NULL
)
```

The result is a `cea_results_list` containing analysis results for each dataset.

```{r print-results}
res
```

# Summary statistics

Descriptive summaries (means, SDs, deltas, ICERs and NMBs) are available in:

```{r summary-table, eval=FALSE}
res$summary_stats
```


```{r summary-table-show}
knitr::kable(as.data.frame(res$summary_stats))
```


Formatted console output:

```{r print-summary, eval=FALSE}
res$summary_stats
```

# Visualizations

CEAgroupR provides four main visualization functions:

- `plot.icers()` – ICER plane  
- `plot.ceacs()` – CEAC  
- `plot.evpis()` – EVPI  
- `plot.marginals()` – distributions of incremental outcomes  

All share a unified graphical engine (`ce_plot_base`) ensuring consistent
colour, shape, grouping, faceting and palette behaviour.

Their aesthetics can be overridden by specifying:

- `color_by`  
- `shape_by`  
- `facet_by`  
- `filter_expr`  
- `palette`  

## ICER Plane

```{r plot-icer, fig.width=9, fig.height=7}
plot.icers(
  res,
  mode     = "Overall"
)
```

## CEAC

```{r plot-ceac, fig.width=9, fig.height=7}
plot.ceacs(
  res,
  mode         = "Overall",
  color_by     = "comparison",
  shape_by     = "dataset",
  facet_by     = "dataset",
  lambda_steps = 80
)
```

## EVPI

```{r plot-evpi, fig.width=9, fig.height=7}
plot.evpis(
  res,
  mode         = "Overall",
  color_by     = "comparison",
  shape_by     = "dataset",
  facet_by     = "dataset",
  lambda_steps = 80
)
```

## Marginal distributions

### Incremental cost

```{r marg-cost, fig.width=9, fig.height=7}
plot.marginals(
  res,
  variable  = "cost",
  geom_type = "density",
  mode      = "Overall",
  color_by  = "comparison",
  shape_by  = "dataset",
  facet_by  = "dataset"
)
```

### Incremental effect

```{r marg-effect, fig.width=9, fig.height=7}
plot.marginals(
  res,
  variable  = "effect",
  geom_type = "histogram",
  mode      = "Overall",
  color_by  = "comparison",
  shape_by  = "dataset",
  facet_by  = "dataset",
  bins      = 30
)
```

# Subgroup visualizations

All visualization functions support subgroup mode:

```{r icer-subgroups, fig.width=10, fig.height=7}
plot.icers(
  res,
  mode     = "Subgroups",
  color_by = "comparison",
  shape_by = "dataset",
  facet_by = "subgroup",
  palette  = "Set2"
)
```

# Custom aesthetics

It is possible to override colour, shape, facets and palettes.

Example:

```{r custom-aesthetics, fig.width=9, fig.height=7}
plot.icers(
  res,
  palette     = "Set1",
  filter_expr = "comparison != 'usual_care'",
  facet_by    = "dataset",
  color_by    = "subgroup_var"
)
```

# Reproducibility notes

- Set a seed for deterministic bootstrap results.
- Summary statistics and replicates can be exported for reporting.
- In vignette examples, `R = 500` is used for performance.

# Session info

```{r session-info}
sessionInfo()
```

